<div class="box">
  <div class="row">
    <%= form_for([:retailers, @product], url: @product.new_record? ? retailers_products_path(current_retailer, @product) : retailers_product_path(current_retailer, @product), local: true, html: { class: 'validate-form p-0 col-xs-12' }) do |f| %>
      <div class="box">
        <div class="row">
          <%= f.hidden_field :id %>

          <fieldset class="col-xs-12 fieldset mt-16">
            <legend>Información básica</legend>
            <div class="mb-8 my-16">
              <%= f.label :title, 'Título' %><br/>
              <%= f.text_field :title, class: 'input validate-required' %>
              <i class="validation-msg"></i>
            </div>

            <% if action_name == 'new' || action_name == 'create' %>
              <div id="root" class="my-16">
                <select name="childs_1" id="childs_1" onchange="appendSelect(this.id);" size="9">
                </select>
                <%= f.hidden_field :category_id, class: 'validate-required' %>
                <i class="validation-msg"></i>
              </div>
            <% end %>

            <% if @retailer.meli_retailer && (@product.new_record? || @product.meli_product_id.blank?) && @product.status != 'archived' %>
              <div class="my-16">
                <%= f.label :upload_product, 'Publicar producto en MercadoLibre' %><br/>
                <% if @product.new_record? %>
                  <%= f.check_box :upload_product, { 'checked': true } %>
                <% elsif @product.meli_product_id.blank? %>
                  <%= f.check_box :upload_product %>
                <% end %>
              </div>
            <% end %>

            <div class="box">
              <div class="row">
                <div class="col-xs-12 pl-0 col-sm-4 my-16">
                  <%= f.label :condition, 'Condición' %><br/>
                  <%= f.select :condition, Product.conditions.keys.collect { |c| [ Product.enum_translation(:condition, c), c ]}, class: 'input' %>
                </div>
                <div class="col-xs-12 col-sm-4 my-16">
                  <%= f.label :price, 'Precio' %><br/>
                  <%= f.text_field :price, class: 'input validate-required' %>
                  <i class="validation-msg"></i>
                </div>
                <div class="col-xs-12 col-sm-4 pr-0 my-16">
                  <%= f.label :available_quantity, 'Cantidad disponible' %><br/>
                  <%= f.number_field :available_quantity, class: 'input validate-required' %>
                  <i class="validation-msg"></i>
                </div>
              </div>
            </div>
          </fieldset>

          <% if action_name == 'edit' || action_name == 'update' %>
            <%= f.hidden_field :category_id, class: 'validate-required' %>
            <fieldset class="col-xs-12 fieldset">
              <div class="box">
                <div class="row">
                  <div class="col-xs-12 pl-0 col-sm-6 my-16">
                    <%= f.label :status, 'Estado del producto' %><br/>
                    <%= f.select :status, Product.statuses.keys.collect { |s| [ Product.enum_translation(:status, s), s ]}, class: 'input', onchange: 'updateMeliStatus(this);' %>
                    <% if @product.meli_product_id && @product.status != 'archived' %>
                      <p class="note-archived"><i>Nota: Si se archiva el producto, la publicación en MercadoLibre se cerrará</i></p>
                    <% end %>
                  </div>

                  <% if @product.meli_product_id %>
                    <div class="col-xs-12 col-sm-6 my-16">
                      <%= f.label :meli_status, 'Estado de la publicación' %><br/>
                      <%= f.select :meli_status, Product.meli_statuses.keys.collect { |m| [ Product.enum_translation(:meli_status, m), m ]}, disabled: @product.disabled_meli_statuses, class: 'input' %>
                    </div>
                  <% end %>
                </div>
              </div>
            </fieldset>
          <% end %>

          <fieldset class="col-xs-12 fieldset">
            <legend>Características</legend>
            <div class="box">
              <div id="attributes-container" class="row pl-0 col-xs-12 my-16"></div>
            </div>
          </fieldset>

          <fieldset class="col-xs-12 fieldset">
            <div class="box">
              <div class="col-xs-12 pl-0 my-16">
                <%= f.label :description, 'Descripción' %>
                <%= f.text_area :description, placeholder: '', class: 'input h-77' %>
              </div>
            </div>
          </fieldset>

          <fieldset id="variations-title" class="col-xs-12 variations-container-title fieldset">
            <legend>Variaciones</legend>
            <div class="box">
              <div id="variations-container" class="row col-xs-12 my-16"></div>
            </div>
            <div class="my-16">
              <a class="btn btn--cta" onclick="appendTemplate(true);">Agregar variación</a>
            </div>
          </fieldset>

          <div id="uploaderImages" class="uploader center w-100 col-xs-12">
            <%= f.label :images, 'Arrastra las imágenes o haz click aquí para seleccionarlas', class: 'py-20 uploader-text' %>
            <%= f.file_field :images, multiple: true, onchange: 'readURL(this);', id: 'uploadedImages' %>
          </div>
          <i class="c-red fs-12" id="product_images_error"></i>
          <div id="up_images" class="row col-xs-12 col-md-12 edit-gallery"></div>

          <div id="image-gallery" class="row col-xs-12 col-md-12 edit-gallery">
            <%= f.hidden_field :main_picture_id %>
            <input type="hidden" id="new-main-image" name="new_main_image" />
            <input type="hidden" id="new-main-image-name" name="new_main_image_name" />
            <%= image_tag 'dashboard/delete-icon.png', class: 'd-none', id: "delete-image" %>

            <% if @product.images.attached? %>
              <div class="col-xs-12 col-md-12 current-images-container">
                <h3>Imágenes actuales:</h3>
              </div>
              <% @product.images.each do |img| %>
                <div id="image-container-<%= img.id.to_s %>" class="col-xs-12 col-md-3 edit-card" onmouseover="showMain(this);" onmouseleave="hideMain(this);">
                  <%= image_tag 'dashboard/delete-icon.png', class: 'delete-icon', onclick: 'removeImage(this);', id: "delete-#{img.id.to_s}" %>
                  <%= cl_image_tag("#{img.key}", class: "image-tag", id: "image-#{img.id.to_s}") %>
                  <p class="main-image-text" id="main-image-<%= img.id.to_s %>" onclick="setMainImage(this);">Foto principal</p>
                </div>
              <% end %>
            <% end %>
          </div>

          <div class="btn-box col-xs-12">
            <%= f.submit 'Guardar', class: 'btn-btn btn-submit', data: { disable_with: false } %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script type="text/javascript">
  $('#product_price').on('change, keyup', function() {
    var currentInput = $(this).val();
    var fixedInput = currentInput.replace(/[A-Za-z!@#$%^&*()]/g, '');
    fixedInput = fixedInput.replace(',', '.');
    $(this).val(fixedInput);
  });
</script>

<script charset="utf-8">
  <% if @product&.errors&.any? %>
    <% @product.errors.each do |attribute, message| %>
      showtoast("<%= message %>")
    <% end %>
  <% end %>
</script>

<script src="<%= asset_path 'retailers/products.js' %>" charset="utf-8"></script>
