<div class="container-fluid reduced-container-padding mb-16">
  <div class="card">
    <div class="container-fluid index">
      <div class="row middle-xs">
        <div class="col-xs-12 col-sm-4">
          <h1 class="d-inline name">Chat</h1>
        </div>
        <div class="col-xs-12 col-sm-8 hide-on-tablet-and-down">
          <div class="index__ctas f-right">
            <%= link_to @return_to == 'order' ? retailers_order_path(current_retailer, @order) : retailers_chats_path(current_retailer), class: 'btn btn--cta' do %>
              <i class="fas fa-arrow-left mr-5"></i>
              Atrás
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid products">
      <div class="row">
        <div class="col-xs-12">
          <fieldset class="fieldset mt-16">
          <legend>Información de los mensajes</legend>
            <div class="box pt-25">
              <div class="row">
                <div class="col-xs-12 col-sm-3">
                  <fieldset class="fieldset mt-16">
                  <legend>Enviado por:</legend>
                    <p>
                      <label class="c-grey fs-14">Usuario:</label> <span class="c-secondary fs-14"><%= @order.customer.first_name.present? ? @order.customer.full_name() : (@order.customer.meli_nickname ||
                      @order.customer.meli_customer.nickname) %></span>
                    </p>
                    <p>
                      <label class="c-grey fs-14">Orden:</label> <span class="c-secondary fs-14"><%= @order.id %></span>
                    </p>
                    <p>
                      <% if @order.products.present? %>
                        <label class="c-grey fs-14">Producto:</label> <span class="c-secondary fs-14"><%= @order.products.first.title %></span>
                      <% else %>
                        <label class="c-grey fs-14">Producto:</label> <span class="c-secondary fs-14"><%= No existen productos %></span>
                      <% end %>
                    </p>
                  </fieldset>
                </div>
                <div class="col-xs-12 col-sm-6">
                  <fieldset class="fieldset mt-16">
                    <legend>Detalles:</legend>
                    <% @order.messages.order(:created_at).each do |m| %>
                      <% if m.sender_id != current_retailer_user.id %>
                        <p>
                          <label class="c-grey fs-14">Fecha:</label> <span class="c-secondary fs-14"><%= show_date(m.created_at) %></span>
                        </p>
                        <p>
                          <label><%= m.question %></label>
                        </p>
                      <% else %>
                        <p class="t-right">
                          <label class="c-grey fs-14">Fecha:</label> <span class="c-secondary fs-14"><%= show_date(m.updated_at) %></span>
                        </p>
                        <p class="t-right">
                          <label><%= m.answer %></label>
                        </p>
                      <% end %>
                    <% end %>
                    <%= form_tag retailers_order_send_message_path do %>
                      <%= hidden_field_tag :order_id, @order.id %>
                      <div class="row mb-10">
                        <%= text_area_tag :answer, nil, placeholder: 'Texto de respuesta', class: 'input h-77' %>
                      </div>
                      <div class="t-center">
                        <%= submit_tag 'Enviar', class: 'btn-btn btn-submit w-100' %>
                      </div>
                    <% end %>
                  </fieldset>
                </div>
                <div id="templates" class="col-xs-12 col-sm-3">
                  <fieldset class="fieldset mt-16">
                  <legend>Plantillas:</legend>
                    <% Retailer.filter_templates(current_retailer, 'chats').each do |template| %>
                      <%= form_tag retailers_order_send_message_path(current_retailer, @order), method: :post do %>
                        <%= hidden_field_tag :answer, template.answer %>
                        <p>
                          <span class="c-secondary fs-16"><%= template.title %></span>
                        </p>
                        <p>
                          <label class="c-grey fs-14"><%= template.answer.truncate(140) %></label>
                        </p>
                        <%= submit_tag 'Enviar', class: 'btn-btn btn-submit w-100' %>
                        <hr/>
                      <% end %>
                    <% end %>
                  </fieldset>
                </div>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
    </div>
  </div>
</div>
