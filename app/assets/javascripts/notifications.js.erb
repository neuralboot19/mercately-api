var http = ENV['ENVIRONMENT'];
var url;

if (http == "production") {
  url = "https://wss.mercately.com/";
} else if (http == "staging") {
  url = "https://swss.mercately.com/";
} else {
  url = "http://" + ENV['DOMAIN'] + ":8181";
}

var socket = io.connect(url);

socket.on('connect', function() {
  socket.emit('create_room', roomId);
});

socket.on('new_message_counter', function(data) {
  var playAlert = false;
  var total = $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).html();

  if (parseInt(total) < parseInt(data['total'])) {
    playAlert = true;
  }

  if (data['update_counter'] === true) {
    $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).html(data['total']);
  }

  if (data['identifier'] === '#item__cookie_message' || data['identifier'] === '#item__cookie_question') {
    $('#sidebar .item__cookie_total, #sidebar--pc .item__cookie_total').html(data['ml_total']);
  }

  play(playAlert, data);
});

function play(playAlert, data) {
  if (playAlert === true && data['execute_alert'] === true) {
    var audio = new Audio('../../notification_tune.mp3');
    audio.play();
    showNotification(data);
  }

  var totalWs = $('#sidebar .item__cookie_whatsapp_messages, #sidebar--pc .item__cookie_whatsapp_messages').html();
  var totalMsn = $('#sidebar .item__cookie_facebook_messages, #sidebar--pc .item__cookie_facebook_messages').html();
  var totalMl = $('#sidebar #item__cookie_total, #sidebar--pc #item__cookie_total').html();

  totalWs = totalWs ? totalWs : 0;
  totalMsn = totalMsn ? totalMsn : 0;
  totalMl = totalMl ? totalMl : 0;

  var total = parseInt(totalWs) + parseInt(totalMsn) + parseInt(totalMl);

  if (total > 0) {
    document.title = `(${total}) Mercately`;
  } else {
    document.title = 'Mercately';
  }
}

function showNotification(data) {
  if ("Notification" in window) {
    if (Notification.permission === 'granted') {
      let options = {
        body: data['message_text'],
        icon: '../../logo.png',
        silent: true
      }

      var notification = new Notification(data['customer_info'] + ' - ' + data['from'], options);
      notification.onclick = function(event) {
        event.preventDefault();

        if (data['from'] === 'Messenger') {
          redirect_to = '/facebook_chats';
        } else if (data['from'] === 'WhatsApp') {
          redirect_to = '/whatsapp_chats';
        } else if (data['from'] === 'MercadoLibre') {
          redirect_to = "/" + data['type'];
        }

        window.focus();
        new_location = window.location.origin + '/retailers/' + ENV['SLUG'] + redirect_to;

        if (window.location.href !== new_location || redirect_to === '/questions') {
          window.location = new_location;
        }
      };
    }
  }
}

$(document).on('ready page:load', function() {
  play();
});
