var http = ENV['ENVIRONMENT'];
var url;

if (http == "production") {
  url = "https://wss.mercately.com/";
} else if (http == "staging") {
  url = "https://swss.mercately.com/";
} else {
  url = "http://" + ENV['DOMAIN'] + ":8181";
}

var socket = io.connect(url);

socket.on('connect', function() {
  socket.emit('create_room', roomId);
});

socket.on('new_message_counter', function(data) {
  if (data['unread_messages'] === true) {
    $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).show();
  } else {
    $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).hide();
  }
  if (data['unread_chats_count']) $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).text(data['unread_chats_count']);

  if (data['identifier'] === '#item__cookie_message' || data['identifier'] === '#item__cookie_question') {
    if (data['unread_total_messages'] === true) {
      $('#sidebar #item__cookie_total, #sidebar--pc #item__cookie_total').show();
    } else {
      $('#sidebar #item__cookie_total, #sidebar--pc #item__cookie_total').hide();
    }

    if (data['unread_ml_messages'] === true) {
      $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).show();
    } else {
      $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).hide();
    }

    if (data['unread_questions'] === true) {
      $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).show();
    } else {
      $(`#sidebar ${data['identifier']}, #sidebar--pc ${data['identifier']}`).hide();
    }
  }

  play(data);
});

function play(data) {
  if (data && data['execute_alert'] === true) {
    let audio = new Audio('../../notification_tune.mp3');
    audio.play();
    showNotification(data);
  }
}

function showNotification(data) {
  if ("Notification" in window) {
    if (Notification.permission === 'granted') {
      let options = {
        body: data['message_text'],
        icon: '../../logo.png',
        silent: true
      }

      let notification = new Notification(data['customer_info'] + ' - ' + data['from'], options);
      notification.onclick = function(event) {
        event.preventDefault();

        if (data['from'] === 'Messenger') {
          redirect_to = '/facebook_chats';
        } else if (data['from'] === 'Instagram') {
          redirect_to = '/instagram_chats';
        } else if (data['from'] === 'WhatsApp') {
          redirect_to = '/whatsapp_chats';
        } else if (data['from'] === 'MercadoLibre') {
          redirect_to = "/" + data['type'];
        }

        window.focus();
        new_location = window.location.origin + '/retailers/' + ENV['SLUG'] + redirect_to;

        if (window.location.href !== new_location || redirect_to === '/questions') {
          window.location = new_location;
        }
      };
    }
  }
}

$(document).ready(function() {
  play();
});
